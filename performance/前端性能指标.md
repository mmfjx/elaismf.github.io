##前端性能指标含义和统计公式

###一、性能监控的重要性

#### 1. 背景
 
 和公司利益相关
> 
 性能    | 收益
------- | -------------
Google  | 延迟 400ms	搜索量下降 0.59%
Bing    |  延迟 2s	收入下降 4.3%
Yahoo   | 延迟 400ms	流量下降 5-9%
Mozilla | 页面打开减少 2.2s	下载量提升 15.4%
Netflix |  开启 Gzip	性能提升 13.25% 带宽减少50%

> 数据来源：http://www.slideshare.net/bitcurrent/impact-of-web-latency-on-conversion-rates http://stevesouders.com/docs/jsdayit-20110511.pptx

> 为什么性能会影响公司的收益呢？根本原因还是在于性能影响了用户体验。加载的延迟、操作的卡顿等都会影响用户的使用体验。尤其是移动端，用户对页面响应延迟和连接中断的容忍度很低。想象一下你拿着手机打开一个网页想看到某个信息却加载半天的心情，你很可能选择直接离开换一个网页。谷歌也将页面加载速度作为 SEO 的一个权重，页面加载速度对用户体验和 SEO 的影响的调研有很多。

> 尽管性能很重要，开发迭代过程中难免会有所忽视，性能会伴随产品的迭代而有所衰减。特别在移动端，网络一直是一个很大的瓶颈，而页面却越来越大，功能越来越复杂。并没有简单的几条黄金规则就可以搞定性能优化工作，我们需要一套性能监控系统持续监控、评估、预警页面性能状况、发现瓶颈，指导优化工作的进行。

####2.意义
>   耗时的评估中，有很多这方面的研究数据。例如有人提出三个基本的时间范围： 
>   
> * 0.1秒 : 0.1 秒是用户感知的最小粒度，在这个时间范围内完成的操作被认为是流畅没有延迟的
> * 1.0秒 : 1.0 秒内完成的响应认为不会干扰用户的思维流。尽管用户能感觉到延迟，但 0.1 秒 -1.0 秒内完成的操作并不需要给出明显 loading 提示
> * 10秒 : 达到 10 秒用户将无法保持注意力，很可能选择离开做其他事情
2/5/8原则：
0~2秒得到响应，用户会感觉响应很快
2-4秒得到响应，用户会感觉响应较快
4-8秒得到响应，用户可以接受
超过8秒得到响应、或没有响应，用户会感觉非常慢，或者认为系统已经失去响应

参考：<https://www.nngroup.com/articles/response-times-3-important-limits/>

###二、Web Performance API
JavaScript API，允许网页访问某些函数来测量网页和Web应用程序的性能  


performance.timing对象下各属性：
![performance.timing](https://timgsa.baidu.com/timg?image&quality=80%20&size=b10000_10000&sec=1509276879318&di=415d7497551fcf3ee36f9024788a3b00&imgtype=jpg&src=http%3A%2F%2Fe.hiphotos.baidu.com%2Fimage%2Fpic%2Fitem%2Ff703738da9773912b739493cf3198618367ae254.jpg)

 每一个performance.timing属性都表示一个页面事件（例如页面发送了请求）
或者页面加载（例如当DOM开始加载），测量以毫秒的形式从1970年1月1日的午夜开始。
结果为0表示该事件未发生。  
各属性意义参考：<http://www.cnblogs.com/mrsunny/archive/2012/09/04/2670727.html>

window.performance.timing对象下各属性和web请求过程的对应关系:

![和web请求过程的对应关系](http://tech.meituan.com/img/performance/http_process.jpeg?wx_lazy=1)

主要利用js来收集不同浏览器下访问网站的加载速度和性能；对于一次完整用户请求来说，http请求可以划分为如下几个阶段：  

* DNS：域名解析阶段，通常在几毫秒左右
* TCP：建立网络连接
* Requesting：发送请求
* WebServer处理
* Transferring：传输数据
* Parsing：浏览器解析。几个重要的时间点为：
	1. 首屏时间 客户端第一屏资源加载完毕
   2. domready时间 DOM解析完毕，可以进行动态修改
   3. load时间 所有资源加载完毕

###三、常用性能指标含义和计算公式

1. **白屏时间（ Time to First Impression）**：无缓存情况下，从开始到页面开始有东西呈现为止
	* 在浏览器地址栏输入URL按回车到用户看到网页的第一个视觉标志为止，第一个视觉标志是浏览器的第一个绘制活动，浏览器绘制内容的起始时间取决于原始的HTML文档，不同的策略有不同的最佳实践，经常能感觉到的一个信号就是网页开始显示title。  
	* 白屏时间包括：DNS时间，TCP连接，发送请求，服务器响应时间，服务器内容传输时间，header静态资源    
	* 测量方式：获取头部资源加载完的时刻来近似统计白屏时间(因为浏览器只有加载并解析完头部资源才会真正渲染页面) , IE 下用 msFirstPaint 取得，Chrome 下利用 loadTimes 取得
	`(chrome.loadTimes().firstPaintTime - chrome.loadTimes().startLoadTime)*1000`
	* 优化方式：选用速度好的DNS服务器，js、css资源压缩与合并，使用cdn，静态资源缓存，启用gzip，js放置在底部
2. **首字节时间**:无缓存情况下，从开始访问到服务器返回第一个字节的时间。
	* 公式：`performance.timing.responseStart - performance.timing.navigationStart `
3. **资源完全加载时间（Time to Fully Loaded）**:无缓存情况下，从开始访问到DOM加载完成且2s内没有任何网络传输，即整个网页完全加载完成并呈现出来所花的时间，即所有OnLoad函数以及相关的动态资源加载完成
	* 公式：`performance.timing.loadEventStart - performance.timing.navigationStart` 	
4. **首屏时间（Time to First Screen）**:无缓存情况下，从开始到首屏渲染完成的时间，即用户浏览器首屏内所有内容都呈现出来所花费的时间(包含图片等元素加载完成)
	* 衡量方式：监听首屏内最后一张图片onLoad事件
	* 优化方式：去掉无意义的图片，使用恰当的图片格式，使用支持SPDY的服务器，静态资源使用独立域名(使用CDN)  
	* 特殊情况：
		* 页面存在 iframe 的情况下也需要判断加载时间
		* gif 图片在 IE 上可能重复触发 load 事件需排除
		* 异步渲染的情况下应在异步获取数据插入之后再计算首屏
		* css 重要背景图片可以通过 JS 请求图片 url 来统计(浏览器不会重复加载)
		* 没有图片则以统计 JS 执行时间为首屏，即认为文字出现时间
5. **用户可操作时间（Time to Operate）**：用户可以进行正常的事件输入交互操作。
	* 测量方式：监听onDomReady时间
	* 优化方式：Dom结构精简，不要使用iframe；使用W3C html标准
	* 公式：`performance.timing. domContentLoadedEventEnd - performance.timing.navigationStart` 


performance api: <https://www.w3.org/TR/resource-timing-1/#introduction-1>

指标含义参考：<https://wiki.sankuai.com/pages/viewpage.action?pageId=442960078>

<mark><http://www.alloyteam.com/2015/09/explore-performance/>

<https://segmentfault.com/a/1190000005784687></mark>

计算公式参考：<https://tech.meituan.com/performance-metric.html>

<https://github.com/addyosmani/timing.js/blob/master/README.md>

<https://tech.meituan.com/performance-framework-and-platform.html>
<http://www.cnblogs.com/chuaWeb/p/PerformanceMonitoring.html>

##四、结算系统性能参数
![msc](file:///Users/mmf/Documents/markdown%E6%96%87%E6%A1%A3/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/msc%20performance.png)
两条竖线，一蓝一红，蓝的代表document触发了domContentLoaded事件，红线代表了document触发了load事件。
![](file:///Users/mmf/Documents/markdown%E6%96%87%E6%A1%A3/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/performance.png)

![](file:///Users/mmf/Documents/markdown%E6%96%87%E6%A1%A3/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/msc%20table.png)